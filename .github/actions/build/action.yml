name: 'Build'
description: 'Builds the binaries'

runs:
  using: 'composite'
  steps:
    - name: Install dependencies for Windows target
      if: matrix.platform.target == 'x86_64-pc-windows-gnu'
      run: |
        sudo apt-get update
        sudo apt-get install -y mingw-w64

    - name: Build
      uses: actions-rs/cargo@v1
      with:
        use-cross: true
        command: build
        args: --release --target ${{ matrix.platform.target }}

    - name: Compress binary
      run: |
        BIN_NAME="admissibility-rust"
        mkdir -p dist
        if [[ "${{ matrix.platform.target }}" == *"windows"* ]]; then
          EXT=".exe"
          zip -j dist/${BIN_NAME}-${{ matrix.platform.os-name }}.zip target/${{ matrix.platform.target }}/release/${BIN_NAME}$EXT
        else
          tar -czvf dist/${BIN_NAME}-${{ matrix.platform.os-name }}.tar.gz -C target/${{ matrix.platform.target }}/release ${BIN_NAME}
        fi